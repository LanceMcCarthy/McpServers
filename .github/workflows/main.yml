name: Build Main (smoketest)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/main.yml'

env:
  csproj_path: src/McpServers.Playground/McpServers.Playground.csproj
  server_json_path: src/McpServers.Playground/.mcp/server.json

jobs:
  build_main:
    name: "Build Main"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate version number (YYYY.Mdd.RunNumber)
        id: tag-creator
        run: |
          buildDay=`date +%Y.%m.%d`
          tags="$buildDay.$GITHUB_RUN_NUMBER"
          echo "VERSION_TAG=$tags" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Update MCP server.json version
        shell: pwsh
        run: |
          $version = "${{steps.version-creator.outputs.DATED_VERSION_NUM}}"
          $jsonPath = "${{env.server_json_path}}"
          $json = Get-Content -Path $jsonPath -Raw | ConvertFrom-Json
          $json.version = $version
          foreach ($pkg in $json.packages) {
            $pkg.version = $version
          }
          $json | ConvertTo-Json -Depth 100 | Set-Content -Path $jsonPath

      - name: Build
        run: |
          dotnet build ${{env.csproj_path}} -c Release \
            -p:PackageVersion="${{steps.tag-creator.outputs.VERSION_TAG}}" \
            -p:AssemblyVersion="${{steps.tag-creator.outputs.VERSION_TAG}}.0" \
            -p:FileVersion="${{steps.tag-creator.outputs.VERSION_TAG}}.0"
