name: Publish package to NuGet

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/main.yml'

env:
  csproj_path: src/McpServers.Playground/McpServers.Playground.csproj
  server_json_path: src/McpServers.Playground/.mcp/server.json

jobs:
  build_main:
    name: "Build Main"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate version number (YYYY.Mdd.RunNumber)
        id: version-creator
        shell: pwsh
        run: |
          $buildDay = Get-Date -Format "yyyy.Mdd"
          $runNumber = "$env:GITHUB_RUN_NUMBER"
          $ver = $buildDay + "." + $runNumber + ".0"
          echo "DATED_VERSION_NUM=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Update MCP server.json version
        shell: pwsh
        run: |
          $version = "${{steps.version-creator.outputs.DATED_VERSION_NUM}}"
          $jsonPath = "${{env.server_json_path}}"
          $json = Get-Content -Path $jsonPath -Raw | ConvertFrom-Json
          $json.version = $version
          foreach ($pkg in $json.packages) {
            $pkg.version = $version
          }
          $json | ConvertTo-Json -Depth 100 | Set-Content -Path $jsonPath

      - name: Pack Package
        run: dotnet build ${{env.csproj_path}} -c Release -p:PackageVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} -p:AssemblyVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} -p:FileVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} 

