name: Publish package to npm

on:
  workflow_dispatch:

jobs:
  npm_publish:
    name: "Publish to NPM"
    runs-on: latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish app to folder
        run: dotnet publish "src/McpServers/McpServers.Playground/McpServers.Playground.csproj" -c Release -r win-x64 --self-contained /p:PublishReadyToRun=true /p:PublishSingleFile=true -o ./npm_publish

      - name: Get current version from npm
        id: get_version
        run: |
          CURRENT_VERSION=$(npm view @lancemccarthy/mcp-playground version || echo "0.0.0")
          echo "Current version: $CURRENT_VERSION"
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="$major.$minor.$NEW_PATCH"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Prepare npm package.json
        run: |
          cat <<EOT > ./npm_publish/package.json
          {
            "name": "@lancemccarthy/mcp-playground",
            "version": "${{env.NEW_VERSION}}",
            "description": "An MCP server containing proof of concept tools to experiment and explore model context protocol.",
            "publishConfig": {
              "access": "public"
            },
            "bin": {
              "mcp-playground": "McpServers.Playground.exe"
            },
            "files": [
              "*"
            ],
            "engines": {
              "node": ">=16.0.0"
            },
            "keywords": ["mcp", ".net", "playground"],
            "author": "Lance McCarthy",
            "license": "MIT"
          }
          EOT

      - name: Add .npmrc for authentication
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ./npm_publish/.npmrc
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}

      - name: Publish to npm
        run: npm publish --access public
        working-directory: ./npm_publish
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
