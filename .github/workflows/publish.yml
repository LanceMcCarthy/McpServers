name: Publish Images and Packages

on:
  workflow_dispatch:

env:
  REPOSITORY: "lancemccarthy/mcp-playground"
  TAG: "latest"

jobs:
  docker_publish:
    name: "Publish to Docker Hub"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get package metadata from Docker Hub
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{env.REPOSITORY}}

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{secrets.DOCKERHUB_USERNAME}}
        password: ${{secrets.DOCKERHUB_PAT}}

    - name: Delete Old Image(s)
      run: |
        curl -X DELETE -H 'Authorization: Bearer ${{secrets.DOCKERHUB_PAT}}' https://hub.docker.com/v2/repositories/${{env.REPOSITORY}}/tags/${{env.TAG}}/

    - name: Build and Publish Images
      uses: docker/build-push-action@v5
      with:
        context: src/McpServers/McpServers.Playground
        platforms: linux/arm64,linux/amd64
        push: true
        tags: ${{env.REPOSITORY}}:${{env.TAG}}

  npm_publish:
    name: "Publish to NPM"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish .NET app
        run: |
          dotnet publish src/McpServers/McpServers.Playground/McpServers.Playground.csproj -c Release -o ./npm_publish

      - name: Prepare npm package.json
        run: |
          cat <<EOT > ./npm_publish/package.json
          {
            "name": "@lancemccarthy/mcp-playground",
            "version": "1.0.0",
            "description": "MCP Playground .NET server as an npm package",
            "bin": {
              "mcp-playground": "McpServers.Playground.dll"
            },
            "files": [
              "McpServers.Playground.dll",
              "McpServers.Playground.deps.json",
              "McpServers.Playground.runtimeconfig.json"
            ],
            "engines": {
              "node": ">=16.0.0"
            },
            "keywords": ["mcp", ".net", "playground"],
            "author": "Lance McCarthy",
            "license": "MIT"
          }
          EOT

      - name: Add .npmrc for authentication
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ./npm_publish/.npmrc
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}

      - name: Publish to npm
        run: npm publish --access public
        working-directory: ./npm_publish
        env:
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
