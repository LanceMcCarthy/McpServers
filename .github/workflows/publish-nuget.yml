name: Publish package to NuGet

on:
  workflow_dispatch:

permissions:
  id-token: write # For NuGet Login OIDC, yay!

env:
  csproj_path: src/McpServers.Playground/McpServers.Playground.csproj
  server_json_path: src/McpServers.Playground/.mcp/server.json

jobs:
  publish_nuget:
    name: "Publish to NuGet"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate version number with date and workflow Run Number
        id: version-creator
        shell: pwsh
        run: |
          $buildDay = Get-Date -Format "yyyy.Mdd"
          $runNumber = "$env:GITHUB_RUN_NUMBER"
          $ver = $buildDay + "." + $runNumber + ".0"
          echo "DATED_VERSION_NUM=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      # https://learn.microsoft.com/en-us/nuget/nuget-org/trusted-publishing
      - name: Get NuGet Authentication
        uses: NuGet/login@v1
        id: nuget-login
        with:
          user: lancemccarthy

      - name: Update MCP server.json version
        shell: pwsh
        run: |
          $version = "${{steps.version-creator.outputs.DATED_VERSION_NUM}}"
          $jsonPath = "${{env.server_json_path}}"
          $json = Get-Content -Path $jsonPath -Raw | ConvertFrom-Json
          $json.version = $version
          foreach ($pkg in $json.packages) {
            $pkg.version = $version
          }
          $json | ConvertTo-Json -Depth 100 | Set-Content -Path $jsonPath

      - name: Pack Package
        run: dotnet pack ${{env.csproj_path}} -c Release -o bin/Release -p:PackageVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} -p:AssemblyVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} -p:FileVersion=${{steps.version-creator.outputs.DATED_VERSION_NUM}} 

      - name: Publish Package (NuGet.org)
        run:  dotnet nuget push bin/Release/*.nupkg --api-key ${{steps.nuget-login.outputs.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json
