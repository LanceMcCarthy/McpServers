name: Publish package to NuGet

on:
  workflow_dispatch:
  push:
    branches:
      - releases/*

permissions:
  id-token: write # For NuGet Login OIDC, yay!

env:
  csproj_path: src/McpServers.Playground/McpServers.Playground.csproj
  server_json_path: src/McpServers.Playground/.mcp/server.json
  nuget_trusted_publisher: lancewmccarthy

jobs:
  publish_nuget:
    name: "Publish to NuGet"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate tag version
        id: tag-creator
        run: |
          buildDay=`date +%Y.%m%d`
          tags="$buildDay.$GITHUB_RUN_NUMBER"
          echo "VERSION_TAG=$tags" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      # https://learn.microsoft.com/en-us/nuget/nuget-org/trusted-publishing
      - name: Get NuGet Authentication
        uses: NuGet/login@v1
        id: nuget-login
        with:
          user: ${{env.nuget_trusted_publisher}}

      - name: Update MCP server.json version
        shell: pwsh
        run: |
          $version = "${{steps.tag-creator.outputs.VERSION_TAG}}"
          $jsonPath = "${{env.server_json_path}}"
          $json = Get-Content -Path $jsonPath -Raw | ConvertFrom-Json
          $json.version = $version
          foreach ($pkg in $json.packages) {
            $pkg.version = $version
          }
          $json | ConvertTo-Json -Depth 100 | Set-Content -Path $jsonPath

      - name: Pack Package
        run: |
          dotnet pack ${{env.csproj_path}} -c Release -o bin/Release \
            -p:PackageVersion="${{steps.tag-creator.outputs.VERSION_TAG}}" \
            -p:AssemblyVersion="${{steps.tag-creator.outputs.VERSION_TAG}}.0" \
            -p:FileVersion="${{steps.tag-creator.outputs.VERSION_TAG}}.0"

      - name: Publish Package (NuGet.org)
        run:  |
          dotnet nuget push bin/Release/*.nupkg \
            --api-key ${{steps.nuget-login.outputs.NUGET_API_KEY}} \
            --source https://api.nuget.org/v3/index.json
